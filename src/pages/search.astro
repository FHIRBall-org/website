---
import { getCollection } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';

const members = await getCollection('members');
---

<BaseLayout title="Search Results">
  <!-- Search Banner Section -->
  <section class="hero-bg relative min-h-[400px] flex flex-col justify-center items-center py-[60px] md:py-[100px] overflow-hidden bg-cover bg-center bg-no-repeat">
    <div class="container max-w-[1200px] mx-auto px-5">
      <div class="flex flex-col justify-center items-center">
        <h1 class="search-heading text-white text-center text-[28px] md:text-[50px] lg:text-[58px] font-light mt-[10px]">
          <strong>SEARCH</strong>
        </h1>
        <form action="/search" method="GET" class="w-full max-w-[80%] mt-6 flex">
          <input
            type="search"
            name="query"
            id="search-input"
            placeholder="Searchâ€¦"
            class="flex-1 h-[50px] px-[30px] text-[20px] border border-[#ddd] rounded-l-[10px] focus:outline-none bg-white"
          />
          <button
            type="submit"
            class="bg-primary hover:bg-primary-hover text-white px-6 h-[50px] rounded-r-[10px] font-semibold transition-colors"
          >
            Search
          </button>
        </form>
      </div>
    </div>
  </section>

  <!-- Search Results -->
  <section class="py-10">
    <div class="max-w-[940px] mx-auto px-5">
      <div id="search-results">
        <p id="no-results" class="text-[14px] text-text-light">No matching results.</p>
      </div>

      <!-- All Members (hidden, used for search) -->
      <div id="all-members" class="hidden">
        {members.map((member) => (
          <div
            class="member-item"
            data-name={member.data.name.toLowerCase()}
            data-description={member.data.description.toLowerCase()}
            data-services={member.data.services?.join(' ').toLowerCase() || ''}
          >
            <a href={`/members/${member.id.replace(/\.md$/, '')}`} class="block bg-white rounded-lg border border-border hover:shadow-lg transition-shadow overflow-hidden">
              <div class="h-[120px] flex items-center justify-center p-4 bg-white">
                {member.data.logo ? (
                  <img
                    src={member.data.logo}
                    alt={member.data.name}
                    class="max-h-full max-w-full object-contain"
                  />
                ) : (
                  <div class="text-[18px] font-bold text-primary">{member.data.name}</div>
                )}
              </div>
              <div class="p-4 text-center border-t border-border">
                <h4 class="font-bold text-text text-[18px]">{member.data.name}</h4>
                {member.data.email && (
                  <p class="mt-1 text-[14px] text-text-light">{member.data.email}</p>
                )}
              </div>
            </a>
          </div>
        ))}
      </div>
    </div>
  </section>
</BaseLayout>

<script>
  const searchInput = document.getElementById('search-input') as HTMLInputElement;
  const searchResults = document.getElementById('search-results');
  const allMembers = document.getElementById('all-members');
  const memberItems = allMembers?.querySelectorAll('.member-item');

  function performSearch(query: string) {
    if (!searchResults || !memberItems) return;

    const trimmedQuery = query.trim().toLowerCase();

    if (trimmedQuery.length < 1) {
      searchResults.innerHTML = '<p class="text-[14px] text-text-light">No matching results.</p>';
      return;
    }

    const matches: Element[] = [];

    memberItems.forEach((item) => {
      const name = item.getAttribute('data-name') || '';
      const description = item.getAttribute('data-description') || '';
      const services = item.getAttribute('data-services') || '';

      if (name.includes(trimmedQuery) || description.includes(trimmedQuery) || services.includes(trimmedQuery)) {
        matches.push(item);
      }
    });

    if (matches.length === 0) {
      searchResults.innerHTML = '<p class="text-[14px] text-text-light">No matching results.</p>';
    } else {
      searchResults.innerHTML = `
        <p class="text-[14px] text-text-light mb-6">Found ${matches.length} result${matches.length !== 1 ? 's' : ''}</p>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5" id="results-grid"></div>
      `;
      const resultsGrid = document.getElementById('results-grid');
      matches.forEach((item) => {
        const clone = item.cloneNode(true) as Element;
        clone.classList.remove('hidden');
        resultsGrid?.appendChild(clone);
      });
    }
  }

  // Incremental search as user types
  searchInput?.addEventListener('input', (e) => {
    const target = e.target as HTMLInputElement;
    performSearch(target.value);
  });

  // Check for query parameter on page load
  const urlParams = new URLSearchParams(window.location.search);
  const initialQuery = urlParams.get('query');
  if (initialQuery && searchInput) {
    searchInput.value = initialQuery;
    performSearch(initialQuery);
  }
</script>
